generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// User and Group Management
// ============================================================================

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String?
  password      String?  // Hashed password for local auth (null for SSO users)
  provider      String   @default("local") // local, azure-entra
  providerId    String?  // External provider user ID
  avatarUrl     String?
  isAdmin       Boolean  @default(false)
  isActive      Boolean  @default(true)
  emailVerified Boolean  @default(false)
  lastLoginAt   DateTime?
  createdAt     DateTime @default(now())

  updatedAt     DateTime @updatedAt

  // Password reset
  resetToken       String?
  resetTokenExpiry DateTime?

  // Sessions for local auth
  sessions      Session[]
  
  // Group memberships
  groupMemberships GroupMember[]
  
  // Folders created by this user
  folders       Folder[]
  
  // Folder permissions granted to this user
  folderPermissions FolderPermission[]
  
  // Workflows created by this user
  workflows     Workflow[]
  createdVersions WorkflowVersion[]
  credentials   Credential[]

  // SDLC Promotions
  requestedPromotions PromotionRequest[] @relation("RequestedPromotions")
  reviewedPromotions  PromotionRequest[] @relation("ReviewedPromotions")

  // Workflow Locks
  workflowLocks WorkflowLock[]
  lockRequests  WorkflowLock[] @relation("LockRequests")
  
  // Workflow Executions
  startedExecutions WorkflowExecution[]



  @@unique([provider, providerId])
  @@index([email])
  @@index([isActive])
}

// Session for local authentication
model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  ipAddress    String?
  userAgent    String?

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

model Group {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isDefault   Boolean  @default(false) // New users auto-join this group
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String?

  // Members of this group
  members     GroupMember[]
  
  // Folders owned by this group
  folders     Folder[]
  
  // Folder permissions granted to this group
  folderPermissions FolderPermission[]
  
  // Workflows in this group (legacy - prefer folder-based organization)
  workflows   Workflow[]
  
  // Credentials accessible to this group
  credentials Credential[]

  @@index([name])
  @@index([isDefault])
}

model GroupMember {
  id        String   @id @default(cuid())
  userId    String
  groupId   String
  role      String   @default("member") // member, admin, owner
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([userId, groupId])
  @@index([userId])
  @@index([groupId])
}

// ============================================================================
// Environments / Stages
// ============================================================================

enum Environment {
  DV  // Development
  UT  // User Testing
  LT  // Load Testing
  PD  // Production
}

// ============================================================================
// Folders for organizing workflows
// ============================================================================

model Folder {
  id          String   @id @default(cuid())
  name        String
  description String?
  color       String?  // Optional color for folder icon
  
  // Parent folder for nested structure (null = root level)
  parentId    String?
  parent      Folder?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    Folder[] @relation("FolderHierarchy")
  
  // Owner - the user who created the folder
  createdById String?
  createdBy   User?    @relation(fields: [createdById], references: [id], onDelete: SetNull)
  
  // Legacy group field (deprecated, use permissions instead)
  groupId     String?
  group       Group?   @relation(fields: [groupId], references: [id], onDelete: SetNull)
  
  // Permissions for this folder
  permissions FolderPermission[]
  
  // Workflows in this folder
  workflows   Workflow[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([parentId])
  @@index([groupId])
  @@index([createdById])
}

// Permission levels for folder access
enum FolderPermissionLevel {
  READ   // Can view workflows in folder
  WRITE  // Can create/edit/delete workflows in folder
  ADMIN  // Can manage folder permissions and delete folder
}

// Folder permissions - grants access to users or groups
model FolderPermission {
  id          String   @id @default(cuid())
  folderId    String
  folder      Folder   @relation(fields: [folderId], references: [id], onDelete: Cascade)
  
  // Either userId OR groupId must be set (not both)
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  groupId     String?
  group       Group?   @relation(fields: [groupId], references: [id], onDelete: Cascade)
  
  permission  FolderPermissionLevel
  
  createdAt   DateTime @default(now())
  createdById String?
  
  @@unique([folderId, userId])
  @@unique([folderId, groupId])
  @@index([folderId])
  @@index([userId])
  @@index([groupId])
}

// ============================================================================
// Workflows and Executions
// ============================================================================

model Workflow {
  id          String   @id @default(cuid())
  name        String
  description String?
  
  // Version number - auto-increments on each save
  version     Int      @default(1)
  
  // Environment/Stage - workflows progress through DV -> UT -> LT -> PD
  environment Environment @default(DV)
  promotedAt  DateTime?   // When last promoted
  promotedById String?    // Who promoted it
  
  // Visual workflow definition (for the editor)
  nodes       Json     @default("[]")
  connections Json     @default("[]")
  settings    Json     @default("{}")
  
  // Generated Python code (for execution)
  pythonWorkflow   String?  @db.Text  // workflow.py content
  pythonActivities String?  @db.Text  // activities.py content
  pythonRequirements String? @db.Text // requirements.txt content
  
  // Workflow properties (global variables)
  properties  Json?    @default("[]")
  
  // Workflow schedule (when to run)
  schedule    Json?
  
  // GitHub integration
  githubRepo       String?  // GitHub repository URL (e.g., owner/repo)
  githubBranch     String?  @default("main") // Branch to commit to
  githubPath       String?  // Path within repo for workflow files
  localPath        String?  // Local filesystem path for the cloned repo
  githubCredentialId String? // Reference to GitHub credential
  lastCommitSha    String?  // Last commit SHA for tracking
  
  active      Boolean  @default(false)
  tags        String[] @default([])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Owner (unchanged - workflow keeps its own owner)
  createdById String?
  createdBy   User?    @relation(fields: [createdById], references: [id], onDelete: SetNull)
  
  // Folder - workflow inherits group permissions from folder
  folderId    String?
  folder      Folder?  @relation(fields: [folderId], references: [id], onDelete: SetNull)
  
  // Legacy direct group assignment (deprecated - use folder.groupId instead)
  groupId     String?
  group       Group?   @relation(fields: [groupId], references: [id], onDelete: SetNull)

  // SDLC
  promotionRequests PromotionRequest[]
  
  // Locking
  lock WorkflowLock?
  
  // Executions
  executions WorkflowExecution[]

  @@index([active])
  @@index([environment])
  @@index([createdAt])
  @@index([groupId])
  @@index([createdById])
  @@index([folderId])
  
  // Versions
  versions WorkflowVersion[]
}

model WorkflowVersion {
  id          String   @id @default(cuid())
  workflowId  String
  workflow    Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  
  version     Int
  
  // Snapshot data
  nodes       Json     @default("[]")
  connections Json     @default("[]")
  settings    Json     @default("{}")
  
  createdAt   DateTime @default(now())
  createdById String?
  createdBy   User?    @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@unique([workflowId, version])
  @@index([workflowId])
}

model Credential {
  id          String   @id @default(cuid())
  name        String
  type        String
  data        Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Owner and group
  createdById String?
  groupId     String?
  
  createdBy   User?    @relation(fields: [createdById], references: [id], onDelete: SetNull)
  group       Group?   @relation(fields: [groupId], references: [id], onDelete: SetNull)

  @@unique([name, type])
  @@index([type])
  @@index([groupId])
  @@index([createdById])
}

// ============================================================================
// SDLC Promotions
// ============================================================================

model PromotionRequest {
  id        String   @id @default(cuid())
  
  // Relations
  workflowId String
  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  
  // Promotion Details
  fromEnv    Environment
  toEnv      Environment
  
  // Actors
  requesterId String
  requester   User     @relation("RequestedPromotions", fields: [requesterId], references: [id])
  
  reviewerId  String?
  reviewer    User?    @relation("ReviewedPromotions", fields: [reviewerId], references: [id])
  
  // State
  status     PromotionStatus @default(PENDING)
  
  // Metadata
  requestNotes String?
  reviewNotes  String?
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([workflowId])
  @@index([status])
  @@index([requesterId])
  @@index([reviewerId])
}

enum PromotionStatus {
  PENDING
  APPROVED
  REJECTED
}

model WorkflowLock {
  id        String   @id @default(cuid())
  
  workflowId String  @unique 
  workflow  Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  updatedAt DateTime @updatedAt // Used as heartbeat timestamp to track active sessions
  createdAt DateTime @default(now())

  // Takeover Request
  requestingUserId String?
  requestingUser   User?   @relation("LockRequests", fields: [requestingUserId], references: [id])
  requestingAt     DateTime?

  @@index([userId])
  @@index([requestingUserId])
}

// ============================================================================
// Workflow Executions and Events
// ============================================================================

model WorkflowExecution {
  id        String   @id @default(cuid())
  
  // Workflow being executed
  workflowId String
  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  
  // Temporal identifiers
  temporalWorkflowId String?
  temporalRunId      String?
  
  // Execution status
  status     String   @default("pending") // pending, running, completed, failed, cancelled
  mode       String   @default("manual")  // manual, trigger, webhook, scheduled, retry
  
  // Timing
  startedAt  DateTime @default(now())
  finishedAt DateTime?
  
  // Input/Output data
  inputData  Json?
  outputData Json?
  
  // Error info (if failed)
  errorMessage String?
  
  // Retry tracking
  retryOf    String?  // ID of original execution if this is a retry
  retriedBy  String?  // ID of retry execution if this was retried
  
  // Who started it
  startedById String?
  startedBy   User?    @relation(fields: [startedById], references: [id], onDelete: SetNull)
  
  // Events for this execution (activity logs)
  events     ExecutionEvent[]
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([workflowId])
  @@index([status])
  @@index([mode])
  @@index([startedAt])
  @@index([temporalWorkflowId])
}

model ExecutionEvent {
  id          String   @id @default(cuid())
  
  // Parent execution
  executionId String
  execution   WorkflowExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)
  
  // Event type
  event       String   // ACTIVITY_STARTED, ACTIVITY_COMPLETED, ACTIVITY_FAILED, ACTIVITY_RETRY, ACTIVITY_HEARTBEAT
  
  // Node info
  nodeId      String
  nodeName    String
  nodeType    String
  
  // Attempt tracking
  attemptNumber Int @default(1)
  
  // Timing
  timestamp   DateTime @default(now())
  durationMs  Float?   // Duration in milliseconds (for COMPLETED events)
  
  // Data summaries (truncated for storage)
  inputSummary  Json?
  outputSummary Json?
  
  // Error info (for FAILED events)
  errorMessage String?
  errorType    String?
  errorStack   String? @db.Text
  
  createdAt   DateTime @default(now())

  @@index([executionId])
  @@index([nodeId])
  @@index([event])
  @@index([timestamp])
}
